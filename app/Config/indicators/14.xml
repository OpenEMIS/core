<indicators>
    <indicator id="14">
        <subgroups>
            <item name="All Sex" type="Sex" order="2">
                <mysql>
                    <select>
                        <![CDATA[
                            (`main_data`.`total` + IFNULL(`indicator_results`.`numerator`, 0)) / (`main_data_b`.`total` + IFNULL(`indicator_results`.`denominator`, 0)) * 100 AS `data_value`,
`main_data`.`total` + IFNULL(`indicator_results`.`numerator`, 0) AS `numerator`,
`main_data_b`.`total` + IFNULL(`indicator_results`.`denominator`, 0) AS `denominator`,
					]]>
                    </select>
                </mysql>
            </item>
            <item name="Male" type="Sex" order="2">
                <mysql>
                    <select>
                        <![CDATA[
                            (`main_data`.`male` + IFNULL(`indicator_results`.`numerator`, 0)) / (`main_data_b`.`male` + IFNULL(`indicator_results`.`denominator`, 0)) * 100 AS `data_value`,
`main_data`.`male` + IFNULL(`indicator_results`.`numerator`, 0) AS `numerator`,
`main_data_b`.`male` + IFNULL(`indicator_results`.`denominator`, 0) AS `denominator`,
					]]>
                    </select>
                </mysql>
            </item>
            <item name="Female" type="Sex" order="2">
                <mysql>
                    <select>
                        <![CDATA[
                            (`main_data`.`female` + IFNULL(`indicator_results`.`numerator`, 0)) / (`main_data_b`.`female` + IFNULL(`indicator_results`.`denominator`, 0)) * 100 AS `data_value`,
`main_data`.`female` + IFNULL(`indicator_results`.`numerator`, 0) AS `numerator`,
`main_data_b`.`female` + IFNULL(`indicator_results`.`denominator`, 0) AS `denominator`,
					]]>
                    </select>
                </mysql>
            </item>
            <item name="All Localities" type="Locality" order="3" reference="InstitutionSiteLocality">
                <mysql>
                    <where>
                        <![CDATA[
                            AND `institution_sites`.`institution_site_locality_id` = {KEY}
						]]>
                    </where>
                </mysql>
            </item>
            <item name="All Sectors" type="Sector" order="5" reference="InstitutionSector">
                <mysql>
                    <where>
                        <![CDATA[
                            AND `institutions`.`institution_sector_id` = {KEY}
						]]>
                    </where>
                </mysql>
            </item>

        </subgroups>
        <query>
            <mysql>
                <insert>
                    <![CDATA[
                        INSERT INTO `batch_indicator_results`
                        SELECT
                        NULL,
                        -- {INDICATOR_ID} AS `batch_indicator_id`,
                        -- {SUBGROUPS} AS `subgroups`,
                        `main_data`.`area_id`,
                        `main_data`.`year` AS `timeperiod`,
                        -- {SELECT}
                        `main_data`.`classification`,
                        -- {USER_ID},
                        NOW()

                        FROM (
                            SELECT
                                `areas`.`id` AS `area_id`,
                                `school_years`.`start_year` AS `year`,
                                `education_cycles`.`education_level_id`,
                                `education_cycles`.`order` AS `education_cycle_order`,
                                SUM(`census_students`.`male`) AS `male`,
                                SUM(`census_students`.`female`) AS `female`,
                                SUM(`census_students`.`male`) + SUM(`census_students`.`female`) AS `total`,
                                CONCAT(`education_level_isced`.`name`, ' - ', `education_cycles`.`name`) AS `classification`
                            FROM `areas`
                            JOIN `institution_sites` ON `institution_sites`.`area_id` = `areas`.`id`
                            JOIN `institutions` ON `institutions`.`id` = `institution_sites`.`institution_id`
                            JOIN `institution_site_programmes` ON `institution_site_programmes`.`institution_site_id` = `institution_sites`.`id`
                            JOIN `education_grades`
                                ON `education_grades`.`education_programme_id` = `institution_site_programmes`.`education_programme_id`
                                AND `education_grades`.`order` = 1
                            JOIN `education_programmes` ON `education_programmes`.`id` = `education_grades`.`education_programme_id`
                            JOIN `education_cycles` ON `education_cycles`.`id` = `education_programmes`.`education_cycle_id`
                            JOIN `education_levels` ON `education_levels`.`id` = `education_cycles`.`education_level_id`
                            JOIN `education_level_isced` ON `education_level_isced`.`id` = `education_levels`.`education_level_isced_id`
                            JOIN `census_students`
                                ON `census_students`.`institution_site_id` = `institution_sites`.`id`
                                AND `census_students`.`education_grade_id` = `education_grades`.`id`
                                AND `census_students`.`student_category_id` = 1 -- PROMOTED
                            JOIN `school_years` ON `school_years`.`id` = `census_students`.`school_year_id`
                            WHERE `areas`.`area_level_id` = -- {LEVEL}
                            -- {WHERE}
                            GROUP BY `areas`.`id`, `school_years`.`id`, `education_cycles`.`id`
                        ) AS `main_data`

                        JOIN (
                            SELECT
                                `areas`.`id` AS `area_id`,
                                `school_years`.`name` AS `year`,
                                `education_cycles`.`education_level_id`,
                                `education_cycles`.`order` AS `education_cycle_order`,
                                SUM(`census_students`.`male`) AS `male`,
                                SUM(`census_students`.`female`) AS `female`,
                                SUM(`census_students`.`male`) + SUM(`census_students`.`female`) AS `total`
                            FROM `areas`
                            JOIN `institution_sites` ON `institution_sites`.`area_id` = `areas`.`id`
                            JOIN `institutions` ON `institutions`.`id` = `institution_sites`.`institution_id`
                            JOIN `institution_site_programmes` ON `institution_site_programmes`.`institution_site_id` = `institution_sites`.`id`
                            JOIN (
                                SELECT
                                    MAX(`education_grades`.`order`) AS `order`,
                                    `education_grades`.`education_programme_id`
                                FROM `education_grades`
                                WHERE `education_grades`.`visible` = 1
                                GROUP BY `education_programme_id`
                            ) AS `education_grades_final`
                                ON `education_grades_final`.`education_programme_id` = `institution_site_programmes`.`education_programme_id`
                            JOIN `education_grades`
                                ON `education_grades`.`education_programme_id` = `institution_site_programmes`.`education_programme_id`
                                AND `education_grades`.`order` = `education_grades_final`.`order`
                            JOIN `education_programmes` ON `education_programmes`.`id` = `education_grades`.`education_programme_id`
                            JOIN `education_cycles` ON `education_cycles`.`id` = `education_programmes`.`education_cycle_id`
                            JOIN `census_students`
                                ON `census_students`.`institution_site_id` = `institution_sites`.`id`
                                AND `census_students`.`education_grade_id` = `education_grades`.`id`
                                AND `census_students`.`student_category_id` = 1 -- PROMOTED
                            JOIN `school_years` ON `school_years`.`id` = `census_students`.`school_year_id`
                            WHERE `areas`.`area_level_id` = -- {LEVEL}
                            -- {WHERE}
                            GROUP BY `areas`.`id`, `census_students`.`school_year_id`, `education_cycles`.`id`
                        ) AS `main_data_b`
                            ON `main_data_b`.`year` = `main_data`.`year` - 1
                            AND `main_data_b`.`area_id` = `main_data`.`area_id`
                            AND `main_data_b`.`education_level_id` = `main_data`.`education_level_id`
                            AND `main_data_b`.`education_cycle_order` = `main_data`.`education_cycle_order` - 1

                        -- Aggregation by Area Start
                        LEFT JOIN (
                            SELECT
                            `areas`.`parent_id` AS `area_parent_id`,
                            `batch_indicator_results`.`timeperiod`,
                            SUM(`batch_indicator_results`.`numerator`) AS `numerator`,
                            SUM(`batch_indicator_results`.`denominator`) AS `denominator`,
                            `batch_indicator_results`.`classification`
                            FROM `batch_indicator_results`
                            JOIN `areas` ON `areas`.`id` = `batch_indicator_results`.`area_id`
                            WHERE `batch_indicator_results`.`batch_indicator_id` = -- {INDICATOR_ID}
                            AND `batch_indicator_results`.`subgroups` = -- {SUBGROUPS}
                            GROUP BY
                            `areas`.`parent_id`,
                            `batch_indicator_results`.`timeperiod`,
                            `batch_indicator_results`.`classification`
                        ) AS `indicator_results`
                            ON `indicator_results`.`area_parent_id` = `main_data`.`area_id`
                            AND `indicator_results`.`timeperiod` = `main_data`.`year`
                            AND `indicator_results`.`classification` = `main_data`.`classification`
                        -- Aggregation by Area End

                        GROUP BY
                        `main_data`.`year`,
                        `main_data`.`area_id`,
                        `main_data`.`education_level_id`
--                        `main_data`.`education_cycle_id`
				]]>
                </insert>
            </mysql>
        </query>

    </indicator>
</indicators>