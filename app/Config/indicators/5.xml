<indicators>
    <indicator id="5">
        <subgroups>
            <item name="All Localities" type="locality" order="3" reference="InstitutionSiteLocality">
                <mysql>
                    <where>
                        <![CDATA[
							AND `institution_sites`.`institution_site_locality_id` = {KEY}
						]]>
                    </where>
                </mysql>
            </item>
            <item name="All Types" type="Type" order="9" reference="InstitutionSiteType">
                <mysql>
                    <where>
                        <![CDATA[
							AND `institution_sites`.`institution_site_type_id` = {KEY}
						]]>
                    </where>
                </mysql>
            </item>

        </subgroups>
        <query>
            <mysql>
                <insert>
                    <![CDATA[
                        INSERT INTO `batch_indicator_results`
                        SELECT
                        NULL,
                        -- {INDICATOR_ID} AS `batch_indicator_id`,
                        -- {SUBGROUPS} AS `subgroups`,
                        `areas`.`id` AS `area_id`,
                        `years`.`year`,
                        COUNT(`institution_sites`.`id`) AS `data_value`,
                        COUNT(`institution_sites`.`id`) AS `numerator`,
                        NULL AS `denominator`,
                        CONCAT('Institution Sites - ', `institution_site_statuses`.`name`) AS `classification`,
                        -- {USER_ID},
                        NOW()

                        FROM (SELECT DISTINCT `year_opened` AS `year` FROM `institution_sites`) AS `years`
							JOIN `institution_sites` 
								ON `institution_sites`.`year_opened` <= `years`.`year`
								AND (`institution_sites`.`year_closed` > `years`.`year` OR `institution_sites`.`year_closed` IS NULL)
							JOIN `institution_site_types` ON `institution_site_types`.`id` = `institution_sites`.`institution_site_type_id`
							JOIN `institution_site_localities` ON `institution_site_localities`.`id` = `institution_sites`.`institution_site_locality_id`
							JOIN `institution_site_statuses` ON `institution_site_statuses`.`id` = `institution_sites`.`institution_site_status_id`
							JOIN `areas` 
								ON `areas`.`id` = `institution_sites`.`area_id`
								AND `areas`.`area_level_id` = -- {LEVEL}
						WHERE 1=1
						-- {WHERE}

						GROUP BY
						-- {GROUP}
						`areas`.`id`,
						`years`.`year`,
						`institution_sites`.`institution_site_status_id`
					]]>
                </insert>
            </mysql>
        </query>
    </indicator>
</indicators>